rm(list=ls())


library(dplyr)
library(RODBC)
library(readxl)
library(stringr)
library(lubridate)
library(ggplot2)
library(scales)
library(RcppRoll)


# ------------------------------------------------------------------------------------
# Connect to Database and Load Data
# ------------------------------------------------------------------------------------

# ODBC CONNECTION
dbhandle <- odbcDriverConnect('driver={SQL Server};
                              server=crhbusadwh02;
                              database=AnalystCM;
                              trusted_connection=true')



Select <- "with cte as (
SELECT  BU = 'F-CH'
,Year
,Month
,Day
,Date = cast(Date as date)
,Orderdate = cast(Orderdate as date)
,s.idItemOrigin
,i.Item
,idCostcenterOrigin = idCostcenterPOSOrigin
,c.Costcenter
,Sales = sum(sales)
,Margin = sum(Margin)
,Quantity = sum(Quantity)
FROM InfoPool_MOV.fact.V_Sales s
LEFT OUTER JOIN InfoPool_MOV.DIM.V_Item i on i.iditem = s.iditem
LEFT OUTER JOIN InfoPool_MOV.DIM.V_Costcenter c on c.idCostcenter = s.idCostcenterPOS
where s.idItemOrigin in ( '10885000', '10885100', '10885200', '10885300', '10885500', '10885600', '10885400', '711813500',
'711813505', '711813510', '715040400', '11339600', '11339601', '11339602', '11339603', '712010000', '712010001', '712010002',
'712010003', '712010004', '710913501', '710913502', '10887500', '711804255', '10894000', '711804915', '7551447', '711804010',
'713672212', '13058830', '10889000', '10889100', '711804150', '711804155', '7551450', '7223020', '714019050', '714019045', '7541282',
'711804460', '711804465', '711809085', '7116258', '7116259', '7116260', '7116261', '7116262', '711804290', '714357200', '713635366',
'713635367', '3725343502A', '3725349502A', '3394111100316', '550003578A', '550003579A', '550002176A', '550002177A', '550001442A',
'3616005100A', '550002185A', '3959550814A', '711803100', '711800000', '7566144', '7530119', '3727143502A', '3727131502A',
'3898439000', '3898431000', '3832290501A', '3171382100A', '3898435000', '3351489100A', '3898432000', '3898436000', '711808915',
'3036302000A', '3898437000', '3898438000', '3727135502A', '3171381100A', '713165050', '7216726', '3898441000', '10882900', '3855035501A',
'3898433000', '3036301000A', '3898440000', '10882800', '10882700', '10882600', '7566301', '7546456', '7546457', '7566220', '711813000',
'711813005', '711813010', '711813015', '711813020', '711813025', '711813030', '711813035', '711813036', '7566072', '7216725', '7565311',
'7565312', '712801500', '711804000', '711808921', '711808650', '711808651', '711808655', '711815005', '711808660', '711808661',
'711808665', '711809500', '711809505', '711806300', '711806500', '711806400', '711806600', '711806200', '711806700', '711809010',
'711809015', '715455062', '1828430', '711805555', '711804100', '11339604', '714021000', '7573126', '7421660', '7421661', '7421662',
'7421663', '7421664', '7421665', '713972637', '713972638', '713964819', '713964816', '713964817', '713964818', '7220840', '7220841',
'7220842', '7220843', '711804260', '711804265', '711804270', '711805405', '711805420', '711805410', '711805415', '711804025', '7541283',
'7540823', '7217986', '7217985', '711804108', '711804109', '711815915', '711804112', '711804110', '711804106', '711804107', '10894500',
'10895000', '714018003', '714018001', '714052401', '714018201', '710951100', '714018204', '10880900', '10881000', '10881100', '10881200',
'10881300', '10881400', '10881500', '10881600', '10881700', '711815905', '711815900', '711815910', '15071096', '15071095', '10883000',
'10883100', '10883900', '10884000', '10884100', '10884200', '10884300', '10883600', '10883400', '711815100', '10884500', '10145500',
'10145550', '12768400', '10167610', '711805425', '711805430', '10890300', '10890100', '10890000', '711813085', '711813090', '711813095',
'711813100', '711813105', '711813110', '711813115', '711813120', '711813125', '711809090', '711809095', '713773013', '713821600',
'711811000', '711811005', '711811010', '711811015', '711811020', '711811050', '711811055', '711811060', '711811065', '711811070',
'711811025', '711811030', '711811035', '711811040', '711811045', '711811075', '711811080', '711811085', '711811090', '711811095',
'711805900', '711805905', '711805910', '711805915', '711805920', '711805925', '711805930', '711805935', '711805940', '711805945',
'711805950', '711805955', '713635316', '711804455', '7100005110', '7100005111', '7100005112', '7100005113', '7100005114', '7100005115',
'7100005116', '7100005117', '7100005118', '7100005119', '7100005120', '7100005121', '7100005122', '7100005123', '7100005124',
'7100005132', '7100005133', '7100005134', '7100005135', '7100005136', '711804310', '711804400', '711804405', '711804410', '711804415',
'711804420', '711804425', '711813195', '711813200', '711813205', '711813210', '711813215', '711813220', '713957773', '713957774',
'713957775', '713957776', '711804435', '711804440', '714620130', '711813515', '714620120', '713169891', '711813520', '713169887',
'714620125', '713762002', '713762003', '711813525', '7570199', '711804105', '715030125', '715030110', '712989600', '715030145',
'713897093', '713897094', '715455067', '715454919', '710002804', '7551443', '713771185', '714593454', '714593455', '714593450',
'714593451', '713762122', '713762175', '713762180', '713762138', '713762139', '713762185', '713762040', '712300245', '712300310',
'713422200', '713422300', '713422500', '711809000', '710002885', '710002890', '714253691', '714253685', '713769905', '7551444',
'7551445', '713981996', '720100470', '7503404' )
and iddistributionchannel = 1
GROUP BY Year
,Month
,Day
,s.idItemOrigin
,idCostcenterPOSOrigin
,c.Costcenter
,i.Item
,cast(Orderdate as date)
,cast(Date as date)

UNION ALL

SELECT  BU = 'D-CH'
,Year
,Month
,Day
,Date = cast(Date as Date)
,Orderdate = cast(Orderdate as date)
,s.idItemOrigin
,i.Item
,idCostcenterOrigin = s.idCostcenterOrigin/10
,c.Costcenter
,Sales = sum(sales)
,Margin = sum(Margin)
,Quantity = sum(Quantity)
FROM crhbusadwh01.InfoPool.fact.V_Sales s
LEFT OUTER JOIN crhbusadwh01.InfoPool.DIM.V_Item i on i.iditem = s.iditem and s.idbusinesssection = i.idbusinesssection
LEFT OUTER JOIN crhbusadwh01.InfoPool.DIM.V_Costcenter c on c.idCostcenter = s.idCostcenter
where s.iditemorigin in ( '4424538', '4424539', '4424540', '4424541', '4424543', '4424544', '4424542', '4477145', '4477146',
'4509215', '7001501', '3807699', '3807700', '3807701', '3807702', '01566725', '01566727', '01566728', '01568271', '01566729',
'3798663', '3798662', '4424560', '5376499', '6376690', '5415735', '7001511', '5376514', '7000599', '3798654', '4447650', '4447651',
'6243715', '6243716', '7001512', '7000610', '7001508', '7001507', '3809590', '6150644', '6150645', '6193526', '01584233', '01584234',
'01584235', '01584236', '01584237', '5376510', '7000596', '5713867', '5713866', '3843242', '3843243', '3803771', '7011895',
'7011896', '7011897', '7011898', '6995184', '6999012', '6995185', '6204475', '4424556', '4424549', '3810137', '3809490', '6995210',
'6995208', '5376471', '5376463', '6185037', '7001431', '5376467', '5376899', '5376464', '5376468', '4477209', '6185035', '5376469',
'5376470', '6995209', '7001430', '4504955', '7000598', '6208659', '5418150', '6185034', '5376465', '6185036', '5376982', '5418149',
'5418148', '5418147', '6204319', '4118541', '4118542', '7000600', '4477219', '4477220', '4477221', '4477222', '4477223', '4477224',
'4477225', '4477226', '4509207', '3810129', '7000597', '6943691', '6943692', '2030976', '4509214', '5713978', '4477150', '4485767',
'4477151', '6243718', '4477152', '4485768', '4477153', '6243364', '6243365', '5415737', '5415826', '5415738', '5415827', '5415736',
'5415828', '5418420', '5418421', '7001502', '01567283', '6144090', '5376472', '3807703', '01573051', '01565166', '5718555', '5718553',
'5718554', '7000604', '7000602', '7000601', '3798651', '3798652', '5418754', '7000603', '7000605', '7000607', '7000620', '6943791',
'7000626', '6943792', '5376500', '5376501', '5376502', '6208664', '6208667', '6208665', '6208666', '5713795', '3809591', '7000616',
'5418585', '6943778', '6243632', '6243633', '5418765', '6188367', '5376485', '6243630', '6243631', '6243717', '6211207', '01567444',
'01567908', '01565882', '01573419', '01567851', '01579185', '4424482', '4424483', '4424484', '4424485', '4424486', '4424487',
'4424488', '4424489', '4424490', '5418763', '4477140', '5418764', '3798655', '3798656', '4424491', '4424492', '4477248', '4477249',
'4477250', '4477251', '4477252', '4476863', '4476861', '4476860', '5376526', '01571442', '6204291', '5714100', '2030739', '6243783',
'6243784', '4483980', '4477141', '4457227', '5376516', '5376517', '5376518', '5376519', '5376520', '5376521', '5376522', '5376523',
'5376524', '5415739', '5415740', '3807721', '01579013', '5415741', '5415742', '5415743', '5415744', '5415745', '5415751', '5415752',
'5415753', '5415754', '5415755', '5415746', '5415747', '5415748', '5415749', '5415750', '5415756', '5415757', '5415758', '5415759',
'5415760', '4477227', '4477228', '4477229', '4477230', '4477231', '4477232', '4477233', '4477234', '4477235', '4477236', '4477237',
'4477238', '2032671', '6150643', '7000606', '7000608', '7000609', '7000611', '7000612', '7000613', '7000614', '7000615', '7000617',
'7000618', '7000619', '7000621', '7000622', '7000623', '7000624', '7000625', '7000627', '7000628', '7000629', '7000630', '5376515',
'5376487', '5376488', '5376489', '5376490', '5376491', '5376492', '6114460', '6114638', '6114713', '6114823', '6114977', '6115047',
'2043723', '01667404', '01572183', '01572184', '5376494', '5376495', '7001500', '5418871', '7001498', '6995045', '5418872', '6995042',
'7001499', '3788992', '3788993', '5418873', '5418520', '5376473', '01671402', '5418610', '5377101', '5418616', '01581535', '01581536',
'6943679', '6943646', '5418077', '6943719', '7001495', '5713892', '5713893', '5713888', '5713889', '5374235', '7001503', '7001504',
'6150690', '6150691', '7001505', '2007676', '5418398', '5418408', '4476757', '4476758', '4476759', '4477247', '6995268', '7001506',
'6995252', '7001496', '6992868', '7001509', '7001510', '7001497', '4119114', '4455937' )
and iddistributionchannel = 1
GROUP BY Year
,Month
,Day
,s.idItemOrigin
,s.idCostcenterOrigin
,c.Costcenter
,i.Item, cast(Orderdate as date), cast(Date as date)

)
select c.*, p.PM, p.[Thema]
from cte c
left outer join 
(
  SELECT [IX]
  ,[Thema]
  ,[Text DE]
  ,[Text FR]
  ,[Text IT]
  ,idItem = [CRHT]
  ,[Sage]
  ,[EP Standard]
  ,[EP Promo]
  ,[VP Standard]
  ,[VP Promo]
  ,[PM]
  FROM [AnalystCM].[PROMO].[2016_Herbspromo_Datenbasis]
  
  UNION ALL
  
  SELECT [IX]
  ,[Thema]
  ,[Text DE]
  ,[Text FR]
  ,[Text IT]
  ,idItem = [Movex]
  ,[Sage]
  ,[EP Standard]
  ,[EP Promo]
  ,[VP Standard]
  ,[VP Promo]
  ,[PM]
  FROM [AnalystCM].[PROMO].[2016_Herbspromo_Datenbasis]
) p on p.idItem = c.idItemOrigin
"

# 
# sql_result <- sqlQuery(dbhandle, Select, as.is=TRUE) %>% 
#   as_data_frame(.) %>% 
#   na.omit
# 
path <- "Data/promo_result_sql.RDS"
# 
# sql_result %>% saveRDS(path)

sql_result <- readRDS(path)

# ------------------------------------------------------------------------------------

df <- sql_result %>% mutate(Date       = ymd(Date),
                            Orderdate  = ymd(Orderdate),
                            Sales      = as.numeric(Sales),
                            Margin     = as.numeric(Margin),
                            Wday       = lubridate::wday(Orderdate) %>% as.factor,
                            Week       = lubridate::week(Orderdate),
                            PromoWoche = ifelse(Week > 36 & Week < 48, "Ja", "Nein") %>% as.factor,
                            Week       = Week %>% as.factor
                            ) %>% 
  filter(Wday != "1")


aktiv_vor_promo <- df %>% 
  filter(PromoWoche == "Nein") %>% 
  select(BU, idItemOrigin) %>%
  distinct() %>% 
  mutate(VorPromo = "Ja")


thema <- df %>%
  select(Thema) %>%
  distinct() %>%
  filter(!(Thema %in% c("Installateur", "Bodenelger-Plattenleger")))


df_analyse <- df %>%
  left_join(aktiv_vor_promo, by = c("BU", "idItemOrigin")) %>% 
  tidyr::replace_na(list(VorPromo = "Nein")) %>% 
  filter(Thema %in% thema$Thema, VorPromo == "Ja") %>% 
  filter(as.numeric(Week) > 14, Year > 2015)


?left_join

df_total <- bind_rows(list(df_analyse, df_analyse %>% mutate(BU = "Total")))

# mutate(Roll_Mean = Sales %>% roll_mean(12, fill = NA)) %>% 

Mittelwert <- df_total %>%
  group_by(BU, Week) %>%
  summarise(SummeWoche = sum(Sales)) %>% 
  group_by(BU) %>% 
  summarise(Mittelwert = mean(SummeWoche))


# Mittelwert <- df_analyse %>%
#   group_by(Week) %>%
#   summarise(SummeWoche = sum(Sales)) %>% 
#   summarise(Mittelwert = mean(SummeWoche))


gplot <- df_total %>%
  filter(Sales > 0, BU != 'Total') %>%
  ggplot(aes(x = Week, y = Sales, fill = PromoWoche, group = 1)) +
  geom_bar(stat = "identity", position = "stack") +
  # geom_line(aes(y = Roll_Mean, x = Week), linetype = 1) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("grey90","grey")) +
  theme(panel.background = element_blank(),
        legend.position = c(0.9, 0.95)) +
  xlab("\nKalenderwoche") +
  ggtitle("Verkaufsentwicklung vor und nach der Promotion 2016") +
  facet_grid(BU~.)

gplot


library(ReporteRs)

mydoc <- pptx()

slide.layouts(mydoc)

mydoc <- addSlide(mydoc, "Title and Content")

# add a plot into mydoc 
mydoc <- addPlot( mydoc, fun = print, x = gplot)




filename <- "Data/base_example.pptx" # the document to produce
# write mydoc 
writeDoc(mydoc, filename)



# Nach Rechnungsdatum
# ------------------------------------------------------------------------------------


# 
# df <- sql_result %>% mutate(Date       = ymd(Date),
#                             Orderdate  = ymd(Date),
#                             Sales      = as.numeric(Sales),
#                             Margin     = as.numeric(Margin),
#                             Wday       = lubridate::wday(Date) %>% as.factor,
#                             Week       = lubridate::week(Date),
#                             PromoWoche = ifelse(Week > 36 & Week < 49, "Ja", "Nein") %>% as.factor,
#                             Week       = Week %>% as.factor
# ) %>% 
#   filter(Wday != "1")
# 
# 
# aktiv_vor_promo <- df %>% 
#   filter(PromoWoche == "Nein") %>% 
#   select(BU, idItemOrigin) %>%
#   distinct() %>% 
#   mutate(VorPromo = "Ja")
# 
# 
# thema <- df %>%
#   select(Thema) %>%
#   distinct() %>%
#   filter(!(Thema %in% c("Installateur", "Bodenelger-Plattenleger")))
# 
# 
# 
# df_analyse <- df %>%
#   left_join(aktiv_vor_promo, by = c("BU", "idItemOrigin")) %>% 
#   mutate(VorPromo = ifelse(is.na(VorPromo), "Nein", VorPromo)) %>% 
#   filter(Thema %in% thema$Thema, VorPromo == "Ja") %>% 
#   group_by(Year, Week, PromoWoche) %>% 
#   summarise(Sales = sum(Sales)) %>% 
#   ungroup() %>% 
#   mutate(Roll_Mean = Sales %>% roll_mean(12, fill = NA)) %>% 
#   filter(as.numeric(Week) > 14, Year > 2015)
# 
# 
# 
# gplot <- df_analyse %>%
#   ggplot(aes(x = Week, y = Sales, fill = PromoWoche, group = 1)) +
#   geom_bar(stat = "identity", position = "stack") +
#   # geom_line(aes(y = Roll_Mean, x = Week), linetype = 1) +
#   scale_y_continuous(labels = scales::comma) +
#   scale_fill_manual(values = c("grey90","grey")) +
#   theme(panel.background = element_blank(),
#         legend.position = c(0.9,0.9)) +
#   xlab("\nKalenderwoche") +
#   ggtitle("Verkaufsentwicklung vor und nach der Promotion 2016")
# 
# 
# gplot


